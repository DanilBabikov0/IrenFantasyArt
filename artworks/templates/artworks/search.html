{% extends 'artworks/base.html' %}
{% load static %}

{% block title %}
    {% if query %}
        Поиск: "{{ query }}" | IrenFantasyArt
    {% else %}
        Поиск по сайту | IrenFantasyArt
    {% endif %}
{% endblock %}

{% block meta_description %}
    Поиск по галерее художника. Ищите картины, коллекции и статьи в блоге.
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Заголовок и форма поиска -->
    <div class="mb-5">
        <h1 class="h2 fw-bold mb-3">
            {% if query %}
                Результаты поиска: "{{ query|escape }}"
            {% else %}
                Поиск по сайту
            {% endif %}
        </h1>
        
        <div class="row">
            <div class="col-lg-8 col-md-10">
                <form action="{% url 'search' %}" method="get" class="search-form">
                    <div class="input-group input-group-lg shadow-sm">
                        <input type="text" 
                               name="q" 
                               class="form-control border-primary border-end-0" 
                               placeholder="Введите название картины, коллекции, тег или статью..."
                               value="{{ query }}"
                               aria-label="Поиск по сайту"
                               required>
                        <button type="submit" class="btn btn-primary border-start-0">
                            <i class="bi bi-search"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-secondary"
                                onclick="document.querySelector('input[name=q]').value = ''; this.form.submit();"
                                {% if not query %}disabled{% endif %}>
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        Ищите по названиям картин, коллекций, тегам или содержанию статей
                    </small>
                </form>
            </div>
        </div>
    </div>
    
    {% if query %}
        <!-- Результаты поиска -->
        <div class="search-results">
            <!-- Статистика -->
            <div class="alert alert-light border mb-4">
                <div class="row">
                    {% if artworks_count or collections_count or posts_count %}
                    <div class="col-auto">
                        <small class="text-muted">Найдено:</small>
                    </div>
                    {% if artworks_count %}
                    <div class="col-auto">
                        <span class="badge bg-primary">
                            <i class="bi bi-palette me-1"></i>
                            Картин: {{ artworks_count }}
                        </span>
                    </div>
                    {% endif %}
                    {% if collections_count %}
                    <div class="col-auto">
                        <span class="badge bg-success">
                            <i class="bi bi-collection me-1"></i>
                            Коллекций: {{ collections_count }}
                        </span>
                    </div>
                    {% endif %}
                    {% if posts_count %}
                    <div class="col-auto">
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-journal-text me-1"></i>
                            Статей: {{ posts_count }}
                        </span>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="col">
                        <small class="text-muted">Пока ничего не найдено...</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Результаты -->
            <div class="row g-4">
                <!-- Картины -->
                {% if results.artworks %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h2 class="h4 card-title mb-3 d-flex align-items-center">
                                <i class="bi bi-palette text-primary me-2"></i>
                                Картины
                                <span class="badge bg-primary ms-2">{{ artworks_count }}</span>
                            </h2>
                            
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
                                {% for artwork in results.artworks %}
                                <div class="col">
                                    <div class="card h-100 border-0 shadow-sm artwork-card">
                                        <a href="{{ artwork.get_absolute_url }}" class="text-decoration-none">
                                            <!-- Изображение -->
                                            {% if artwork.images.all %}
                                                <img src="{{ artwork.images.first.image.url }}" 
                                                     class="card-img-top artwork-image" 
                                                     alt="{{ artwork.title }}"
                                                     style="height: 180px; object-fit: cover;">
                                            {% else %}
                                                <div class="card-img-top artwork-image bg-light d-flex align-items-center justify-content-center" 
                                                     style="height: 180px;">
                                                    <i class="bi bi-image text-muted fs-1"></i>
                                                </div>
                                            {% endif %}
                                            
                                            <div class="card-body d-flex flex-column">
                                                <h5 class="card-title text-dark mb-1 fs-6">{{ artwork.title }}</h5>
                                                
                                                <!-- Мета информация -->
                                                <div class="mb-2">
                                                    {% if artwork.category %}
                                                    <small class="text-muted d-block">
                                                        <i class="bi bi-palette me-1"></i>{{ artwork.category.name }}
                                                    </small>
                                                    {% endif %}
                                                    <small class="text-muted d-block">
                                                        <i class="bi bi-calendar me-1"></i>{{ artwork.created_year }}
                                                    </small>
                                                </div>
                                                
                                                <!-- Цена -->
                                                <div class="mt-auto">
                                                    <div class="{% if artwork.status == 'sold' %}text-danger{% else %}text-primary{% endif %} fw-bold">
                                                        {{ artwork.get_price_display }}
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if artworks_count > 8 %}
                            <div class="text-center mt-4">
                                <a href="{% url 'catalog' %}?q={{ query|urlencode }}" class="btn btn-outline-primary">
                                    <i class="bi bi-arrow-right me-1"></i>
                                    Все картины по запросу "{{ query|escape }}"
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Коллекции -->
                {% if results.collections %}
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h2 class="h4 card-title mb-3 d-flex align-items-center">
                                <i class="bi bi-collection text-success me-2"></i>
                                Коллекции
                                <span class="badge bg-success ms-2">{{ collections_count }}</span>
                            </h2>
                            
                            <div class="list-group list-group-flush">
                                {% for collection in results.collections %}
                                <a href="{{ collection.get_absolute_url }}" 
                                   class="list-group-item list-group-item-action border-0 py-3 px-0">
                                    <div class="d-flex align-items-center">
                                        {% if collection.image %}
                                        <div class="flex-shrink-0 me-3">
                                            <img src="{{ collection.image.url }}" 
                                                 class="rounded" 
                                                 alt="{{ collection.name }}"
                                                 style="width: 60px; height: 60px; object-fit: cover;">
                                        </div>
                                        {% else %}
                                        <div class="flex-shrink-0 me-3">
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                                 style="width: 60px; height: 60px;">
                                                <i class="bi bi-collection text-muted"></i>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ collection.name }}</h6>
                                            {% if collection.description %}
                                            <p class="text-muted small mb-0">{{ collection.description|truncatechars:80 }}</p>
                                            {% endif %}
                                            <small class="text-muted">
                                                <i class="bi bi-images me-1"></i>{{ collection.artwork_count }} работ
                                            </small>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <i class="bi bi-chevron-right text-muted"></i>
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Статьи блога -->
                {% if results.posts %}
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h2 class="h4 card-title mb-3 d-flex align-items-center">
                                <i class="bi bi-journal-text text-warning me-2"></i>
                                Статьи в блоге
                                <span class="badge bg-warning text-dark ms-2">{{ posts_count }}</span>
                            </h2>
                            
                            <div class="list-group list-group-flush">
                                {% for post in results.posts %}
                                <a href="{% url 'blog_post_detail' post.slug %}" 
                                   class="list-group-item list-group-item-action border-0 py-3 px-0">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="mb-0">{{ post.title }}</h6>
                                        <small class="text-muted">{{ post.published_at|date:"d.m.Y" }}</small>
                                    </div>
                                    {% if post.excerpt %}
                                    <p class="text-muted small mb-2">{{ post.excerpt|truncatechars:100 }}</p>
                                    {% endif %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="bi bi-person me-1"></i>
                                            {% if post.author.get_full_name %}
                                                {{ post.author.get_full_name }}
                                            {% else %}
                                                {{ post.author.username }}
                                            {% endif %}
                                        </small>
                                        <small class="text-muted">
                                            <i class="bi bi-eye me-1"></i>{{ post.views }}
                                        </small>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                            
                            <div class="mt-3">
                                <a href="{% url 'blog_list' %}?q={{ query|urlencode }}" class="btn btn-sm btn-outline-warning">
                                    <i class="bi bi-arrow-right me-1"></i>
                                    Все статьи по запросу "{{ query|escape }}"
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Нет результатов -->
            {% if not results.artworks and not results.collections and not results.posts %}
            <div class="text-center py-5 my-5">
                <div class="mb-4">
                    <i class="bi bi-search display-1 text-muted"></i>
                </div>
                <h3 class="mb-3">Ничего не найдено</h3>
                <p class="text-muted mb-4">
                    По запросу "{{ query|escape }}" ничего не найдено.<br>
                    Попробуйте изменить формулировку или искать по другим ключевым словам.
                </p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="{% url 'catalog' %}" class="btn btn-outline-primary">
                        <i class="bi bi-palette me-1"></i>Каталог картин
                    </a>
                    <a href="{% url 'blog_list' %}" class="btn btn-outline-warning">
                        <i class="bi bi-journal-text me-1"></i>Блог
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    {% else %}
        <!-- Пустая страница поиска без запроса -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-search display-1 text-primary"></i>
                        </div>
                        <h3 class="mb-3">Что будем искать?</h3>
                        <p class="text-muted mb-4">
                            Введите запрос в поле выше, чтобы найти:<br>
                            • Картины по названию, описанию или тегам<br>
                            • Коллекции по названию или описанию<br>
                            • Статьи в блоге по заголовку или содержанию
                        </p>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <i class="bi bi-palette fs-2 text-primary mb-2 d-block"></i>
                                        <h5 class="h6">Картины</h5>
                                        <p class="text-muted small">Более {{ total_artworks }} работ в каталоге</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <i class="bi bi-collection fs-2 text-success mb-2 d-block"></i>
                                        <h5 class="h6">Коллекции</h5>
                                        <p class="text-muted small">{{ total_collections }} коллекций</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <i class="bi bi-journal-text fs-2 text-warning mb-2 d-block"></i>
                                        <h5 class="h6">Блог</h5>
                                        <p class="text-muted small">{{ total_posts }} опубликованных статей</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Автоматический фокус на поле поиска при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
        searchInput.focus();
        // Помещаем курсор в конец текста
        if (searchInput.value) {
            searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
        }
    }
});
</script>
{% endblock %}